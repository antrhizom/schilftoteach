<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weiterbildung to-teach.ai</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .nav { background: rgba(255, 255, 255, 0.95); padding: 15px 30px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; border-radius: 10px; flex-wrap: wrap; gap: 15px; }
        .nav-links { display: flex; gap: 15px; flex-wrap: wrap; }
        .nav-link { padding: 8px 16px; border-radius: 5px; background: #e0e0e0; color: #667eea; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .nav-link:hover, .nav-link.active { background: #667eea; color: white; }
        .user-info { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .group-badge { padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: 600; color: white; }
        .group-badge.nilpferde { background: #3498db; }
        .group-badge.ameise { background: #e74c3c; }
        .group-badge.schildkroeten { background: #2ecc71; }
        .group-badge.drachen { background: #f39c12; }
        .group-badge.kuehe { background: #9b59b6; }
        .logout-btn { background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: 600; }
        .card { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); margin-bottom: 20px; }
        .card h1, .card h2 { color: #667eea; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        .group-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
        .group-option { padding: 20px; border: 3px solid transparent; border-radius: 10px; cursor: pointer; text-align: center; font-weight: 600; font-size: 18px; color: white; transition: all 0.3s; }
        .group-option:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        .group-option.selected { border-color: #fff; box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.5), 0 4px 20px rgba(0, 0, 0, 0.3); transform: scale(1.08); }
        .group-option.nilpferde { background: #3498db; }
        .group-option.ameise { background: #e74c3c; }
        .group-option.schildkroeten { background: #2ecc71; }
        .group-option.drachen { background: #f39c12; }
        .group-option.kuehe { background: #9b59b6; }
        .btn { padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover:not(:disabled) { background: #5568d3; transform: translateY(-2px); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .error-message { color: #e74c3c; margin-top: 10px; }
        .success-message { color: #2ecc71; margin-top: 10px; font-weight: 600; }
        .code-display { background: #fff3e0; border: 3px dashed #f39c12; border-radius: 10px; padding: 20px; text-align: center; margin: 20px 0; }
        .code-display .code { font-size: 32px; font-weight: 700; color: #f39c12; letter-spacing: 3px; font-family: monospace; }
        .login-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .login-tab { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; text-align: center; font-weight: 600; transition: all 0.3s; }
        .login-tab.active { background: #667eea; color: white; border-color: #667eea; }
        .progress-bar-container { margin: 30px 0; }
        .progress-info { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: 600; }
        .progress-bar { height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.5s ease; }
        .task-item { background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 20px; transition: all 0.3s; }
        .task-item:hover { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .task-item.completed { background: #e8f5e9; border-color: #4caf50; }
        .task-main-header { display: flex; gap: 15px; align-items: flex-start; margin-bottom: 15px; }
        .task-icon { width: 60px; height: 60px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 36px; flex-shrink: 0; background: #f0f0f0; border: 3px solid; }
        .task-icon.lion-red { border-color: #e74c3c; background: #ffebee; }
        .task-icon.lion-blue { border-color: #3498db; background: #e3f2fd; }
        .task-icon.lion-green { border-color: #2ecc71; background: #e8f5e9; }
        .task-icon.lion-orange { border-color: #f39c12; background: #fff3e0; }
        .task-icon.lion-purple { border-color: #9b59b6; background: #f3e5f5; }
        .task-icon.lion-yellow { border-color: #f1c40f; background: #fffde7; }
        .task-icon.lion-teal { border-color: #1abc9c; background: #e0f2f1; }
        .task-icon.lion-pink { border-color: #e91e63; background: #fce4ec; }
        .task-main-content { flex: 1; }
        .task-title { font-weight: 700; margin-bottom: 5px; font-size: 18px; color: #333; }
        .task-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; margin-left: 10px; }
        .task-badge.individual { background: #fff3e0; color: #f57c00; }
        .task-badge.group { background: #e3f2fd; color: #1976d2; }
        .task-progress { font-size: 14px; color: #666; margin-top: 5px; }
        .subtasks { margin-top: 15px; }
        .subtask-item { display: flex; align-items: flex-start; gap: 12px; padding: 10px; margin-bottom: 8px; background: white; border-radius: 8px; transition: all 0.3s; }
        .subtask-item:hover { background: #f0f7ff; }
        .subtask-item.completed { background: #e8f5e9; }
        .subtask-checkbox { width: 20px; height: 20px; cursor: pointer; flex-shrink: 0; margin-top: 2px; }
        .subtask-text { flex: 1; color: #555; line-height: 1.5; }
        .task-rating-display { margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0; font-size: 14px; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-content { background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-content h2 { color: #667eea; margin-bottom: 10px; }
        .rating-question { margin: 25px 0; }
        .rating-question label { display: block; font-weight: 600; color: #333; margin-bottom: 12px; font-size: 16px; }
        .rating-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .rating-btn { padding: 15px 10px; border: 2px solid #ddd; border-radius: 10px; background: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .rating-btn:hover { border-color: #667eea; transform: translateY(-2px); }
        .rating-btn.selected { color: white; border-color: transparent; transform: scale(1.05); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        .rating-btn-emoji { font-size: 24px; }
        .rating-btn-label { font-size: 13px; }
        .external-links { display: flex; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0; flex-wrap: wrap; }
        .external-link-btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 14px; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s; border: 2px solid; }
        .external-link-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        .external-link-btn.pdf { background: #f3e5f5; color: #9b59b6; border-color: #9b59b6; }
        .external-link-btn.whiteboard { background: #e3f2fd; color: #1976d2; border-color: #1976d2; }
        .external-link-btn.padlet { background: #fff3e0; color: #f57c00; border-color: #f57c00; }
        .modal-actions { display: flex; gap: 15px; margin-top: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: #f8f9fa; border-left: 5px solid; border-radius: 10px; padding: 20px; text-align: center; }
        .stat-emoji { font-size: 36px; margin-bottom: 10px; }
        .stat-value { font-size: 28px; font-weight: 700; color: #667eea; }
        .stat-label { color: #666; font-size: 14px; margin-top: 5px; }
        .task-stats { margin-top: 30px; }
        .task-stat-item { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px; }
        .task-stat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .subtask-stats { margin-top: 10px; padding-left: 20px; }
        .subtask-stat { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e0e0e0; }
        .stat-bar { height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .stat-bar-fill { height: 100%; transition: width 0.5s; }
        .user-list { margin-top: 30px; }
        .user-row { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .user-name { font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .mini-badge { padding: 3px 10px; border-radius: 12px; font-size: 12px; color: white; }
        .progress-mini { flex: 1; min-width: 200px; }
        .progress-mini-bar { height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .progress-mini-fill { height: 100%; transition: width 0.5s; }
        .comment-form { background: #f8f9fa; border-radius: 12px; padding: 25px; margin-bottom: 30px; }
        .comment-textarea { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; font-family: inherit; resize: vertical; min-height: 100px; }
        .comments-list { margin-top: 30px; }
        .comment-item { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid; }
        .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .comment-author { font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .comment-text { color: #555; line-height: 1.6; white-space: pre-wrap; }
        .comment-date { font-size: 12px; color: #999; }
        .delete-comment-btn { background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; }
        .loading { text-align: center; padding: 50px; color: white; font-size: 20px; }
        .group-filter { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; align-items: center; }
        .group-filter-label { font-weight: 600; color: #333; }
        .group-filter-badge { padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s; border: 3px solid transparent; }
        .group-filter-badge:hover { transform: scale(1.05); }
        .group-filter-badge.active { border-color: white; box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3), 0 4px 12px rgba(0, 0, 0, 0.2); }
        .group-filter-badge.all { background: #667eea; }
        .rating-stats { margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; }
        .rating-stats-header { font-weight: 600; margin-bottom: 15px; color: #667eea; display: flex; justify-content: space-between; align-items: center; }
        .rating-question-stats { margin-bottom: 20px; }
        .rating-question-label { font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .rating-bar-group { display: flex; gap: 5px; margin-bottom: 5px; }
        .rating-bar-item { flex: 1; text-align: center; }
        .rating-bar-visual { height: 30px; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; transition: all 0.3s; }
        .rating-bar-visual:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        .rating-bar-visual.positive { background: #4caf50; }
        .rating-bar-visual.negative { background: #f44336; }
        .rating-bar-visual.neutral { background: #999; }
        .rating-bar-label { font-size: 12px; color: #666; margin-top: 5px; }
        .anonymous-note { background: #fff3e0; border-left: 4px solid #f39c12; padding: 12px 15px; border-radius: 5px; margin-bottom: 15px; font-size: 14px; color: #666; }
        .anonymous-note strong { color: #f39c12; }
        @media (max-width: 768px) {
            .nav { flex-direction: column; }
            .group-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
            .task-icon { width: 50px; height: 50px; font-size: 28px; }
            .rating-options, .modal-actions { flex-direction: column; }
            .modal-actions button { width: 100%; }
            .external-links { flex-direction: column; }
            .external-link-btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <div id="app"><div class="loading">L√§dt...</div></div>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, get, set, push, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyC5WFZHxE19M5lN08cHBD_1P5x2zDuLNHI",
            authDomain: "weiterbildung-to-teach.firebaseapp.com",
            databaseURL: "https://weiterbildung-to-teach-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "weiterbildung-to-teach",
            storageBucket: "weiterbildung-to-teach.firebasestorage.app",
            messagingSenderId: "316765773128",
            appId: "1:316765773128:web:7ae13ea61f3e9c2e52677d"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const GROUPS = {
            nilpferde: { name: 'Nilpferde', emoji: 'ü¶õ', color: '#3498db' },
            ameise: { name: 'Ameise', emoji: 'üêú', color: '#e74c3c' },
            schildkroeten: { name: 'Schildkr√∂ten', emoji: 'üê¢', color: '#2ecc71' },
            drachen: { name: 'Drachen', emoji: 'üêâ', color: '#f39c12' },
            kuehe: { name: 'K√ºhe', emoji: 'üêÑ', color: '#9b59b6' }
        };

        const TASKS = [
            { id: 1, title: 'Ein KI-Chatbot steht zur Verf√ºgung', type: 'individual', lionColor: 'lion-red', lionEmoji: 'ü¶Å',
              subtasks: ['Ich habe Zugriff auf den KI-Chat von Microsoft', 'Ich weiss, dass ich den Input genau definieren muss'],
              pdfUrl: './public/pdfs/aufgabe-1-ki-chatbot.pdf' },
            
            { id: 2, title: 'Registrierung Schullizenz', type: 'individual', lionColor: 'lion-blue', lionEmoji: 'ü¶Å',
              subtasks: ['Ich bin bei Fobizz registriert', 'Ich habe den Pro-Plan in to-teach.ai'],
              pdfUrl: './public/pdfs/aufgabe-2-registrierung.pdf' },
            
            { id: 3, title: 'Erste Schritte in to-teach.ai', type: 'individual', lionColor: 'lion-green', lionEmoji: 'ü¶Å',
              subtasks: ['Ich habe ein Youtube-Aufgabenblatt erstellt', 'Ich habe eine Powerpoint erstellt', 'Ich habe eine Infografik erstellt'],
              pdfUrl: './public/pdfs/aufgabe-3-erste-schritte.pdf' },
            
            { id: 4, title: 'Gruppenarbeit A', type: 'group', lionColor: 'lion-orange', lionEmoji: 'üë•',
              subtasks: ['Zwischenstandkontrolle in der Gruppe', 'Einzellinks sind auf dem Whiteboard festgehalten'],
              whiteboardUrl: '',
              padletUrl: '' },
            
            { id: 5, title: 'Aufgabenbausteine kennenlernen', type: 'individual', lionColor: 'lion-purple', lionEmoji: 'ü¶Å',
              subtasks: ['Ich habe den Baustein ‚ÄûAussagen" erstellt', 'Ich habe den Baustein ‚ÄûMindmap" erstellt', 'Ich habe den Baustein ‚ÄûWhatsapp Chat" erstellt'],
              pdfUrl: './public/pdfs/aufgabe-5-bausteine.pdf' },
            
            { id: 6, title: 'Organisation von to-teach.ai-Inhalten', type: 'individual', lionColor: 'lion-yellow', lionEmoji: 'ü¶Å',
              subtasks: ['Ich habe zwei Ordner erstellt', 'Ich habe einen Kurs erstellt'],
              pdfUrl: './public/pdfs/aufgabe-6-organisation.pdf' },
            
            { id: 7, title: 'Gruppenarbeit B', type: 'group', lionColor: 'lion-teal', lionEmoji: 'üë•',
              subtasks: ['Zwischenstandkontrolle in der Gruppe', 'Einzellinks sind auf dem Whiteboard festgehalten'],
              whiteboardUrl: '',
              padletUrl: '' },
            
            { id: 8, title: 'Gruppenarbeit C', type: 'group', lionColor: 'lion-pink', lionEmoji: 'üë•',
              subtasks: ['Entscheid in der Gruppe, welche Links auf das Padlet kommen', 'Mindestens f√ºnf Links mit Begr√ºndung'],
              whiteboardUrl: '',
              padletUrl: '' }
        ];

        const RATING_QUESTIONS = [
            { id: 'enjoyed', label: 'Hat es mir Spa√ü gemacht?', emoji: 'üòä' },
            { id: 'useful', label: 'War es sinnvoll?', emoji: 'üí°' },
            { id: 'learned', label: 'Habe ich etwas gelernt?', emoji: 'üìö' }
        ];

        const RATING_OPTIONS = [
            { value: 3, label: 'Sehr', emoji: 'üëç', color: '#4caf50' },
            { value: 2, label: 'Eher ja', emoji: '‚úì', color: '#8bc34a' },
            { value: 1, label: 'Eher nein', emoji: '‚úó', color: '#ff9800' },
            { value: 0, label: 'Gar nicht', emoji: 'üëé', color: '#f44336' }
        ];

        function generateCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        let currentUser = null;
        let currentPage = 'login';
        let loginMode = 'new';
        let completedSubtasks = {};
        let ratings = {};
        let allUsers = [];
        let comments = [];
        let showRatingModal = null;
        let tempRating = {};
        let newUserCode = null;
        let selectedGroupFilter = null;

        async function init() {
            const savedUserId = localStorage.getItem('currentUserId');
            if (savedUserId) {
                try {
                    const userRef = ref(database, `users/${savedUserId}`);
                    const snapshot = await get(userRef);
                    if (snapshot.exists()) {
                        currentUser = { ...snapshot.val(), userId: savedUserId };
                        currentPage = 'checkliste';
                        await loadUserData();
                    } else {
                        localStorage.removeItem('currentUserId');
                    }
                } catch (err) {
                    console.error(err);
                }
            }
            render();
        }

        async function loadUserData() {
            if (!currentUser) return;
            try {
                const userRef = ref(database, `users/${currentUser.userId}`);
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    completedSubtasks = data.completedSubtasks || {};
                    ratings = data.ratings || {};
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function loadAllUsers() {
            try {
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);
                if (snapshot.exists()) {
                    const usersData = snapshot.val();
                    allUsers = Object.entries(usersData).map(([id, data]) => ({ userId: id, ...data }));
                } else {
                    allUsers = [];
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function loadComments() {
            try {
                const commentsRef = ref(database, 'comments');
                const snapshot = await get(commentsRef);
                if (snapshot.exists()) {
                    const commentsData = snapshot.val();
                    comments = Object.entries(commentsData).map(([id, data]) => ({ id, ...data }))
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                } else {
                    comments = [];
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function handleNewUser(username, group) {
            if (!username || !group) return 'Bitte Namen und Gruppe ausw√§hlen';

            try {
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    const exists = Object.values(users).some(
                        u => u.username.toLowerCase() === username.toLowerCase()
                    );
                    if (exists) {
                        return 'Dieser Name ist bereits vergeben';
                    }
                }

                const code = generateCode();
                const userId = Date.now().toString();
                const newUser = {
                    username: username.trim(),
                    group: group,
                    code: code,
                    createdAt: new Date().toISOString(),
                    completedSubtasks: {},
                    ratings: {}
                };

                await set(ref(database, `users/${userId}`), newUser);
                
                newUserCode = code;
                currentUser = { ...newUser, userId };
                
                render();
                return null;
            } catch (err) {
                console.error(err);
                return 'Fehler beim Erstellen des Accounts';
            }
        }

        async function handleExistingUser(code) {
            if (!code) return 'Bitte Code eingeben';

            try {
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    const foundUser = Object.entries(users).find(
                        ([id, u]) => u.code && u.code.toUpperCase() === code.toUpperCase()
                    );
                    
                    if (foundUser) {
                        const [userId, userData] = foundUser;
                        currentUser = { ...userData, userId };
                        localStorage.setItem('currentUserId', userId);
                        currentPage = 'checkliste';
                        await loadUserData();
                        render();
                        return null;
                    } else {
                        return 'Code nicht gefunden';
                    }
                }
                return 'Code nicht gefunden';
            } catch (err) {
                console.error(err);
                return 'Fehler beim Anmelden';
            }
        }

        function handleLogout() {
            if (confirm('Wirklich abmelden?')) {
                currentUser = null;
                localStorage.removeItem('currentUserId');
                currentPage = 'login';
                completedSubtasks = {};
                ratings = {};
                newUserCode = null;
                render();
            }
        }

        function getSubtaskKey(taskId, subtaskIndex) {
            return `${taskId}-${subtaskIndex}`;
        }

        function isTaskFullyCompleted(taskId) {
            const task = TASKS.find(t => t.id === taskId);
            if (!task) return false;
            for (let i = 0; i < task.subtasks.length; i++) {
                if (!completedSubtasks[getSubtaskKey(taskId, i)]) return false;
            }
            return true;
        }

        async function toggleSubtask(taskId, subtaskIndex) {
            const key = getSubtaskKey(taskId, subtaskIndex);
            const newCompleted = { ...completedSubtasks };
            
            if (newCompleted[key]) {
                delete newCompleted[key];
            } else {
                newCompleted[key] = new Date().toISOString();
            }

            completedSubtasks = newCompleted;
            await set(ref(database, `users/${currentUser.userId}/completedSubtasks`), newCompleted);

            if (isTaskFullyCompleted(taskId) && !ratings[taskId]) {
                setTimeout(() => {
                    showRatingModal = taskId;
                    tempRating = { enjoyed: null, useful: null, learned: null };
                    render();
                }, 300);
            }
            
            render();
        }

        async function submitRating() {
            const taskId = showRatingModal;
            const newRatings = { ...ratings };
            newRatings[taskId] = { ...tempRating, timestamp: new Date().toISOString() };
            ratings = newRatings;

            await set(ref(database, `users/${currentUser.userId}/ratings`), newRatings);
            showRatingModal = null;
            tempRating = {};
            render();
        }

        function skipRating() {
            showRatingModal = null;
            tempRating = {};
            render();
        }

        function setRating(questionId, value) {
            tempRating[questionId] = parseInt(value);
            render();
        }

        async function postComment(text) {
            if (!text.trim()) return;
            try {
                const commentsRef = ref(database, 'comments');
                await push(commentsRef, {
                    userId: currentUser.userId,
                    username: currentUser.username,
                    group: currentUser.group,
                    text: text.trim(),
                    timestamp: new Date().toISOString()
                });
                await loadComments();
                render();
            } catch (err) {
                console.error(err);
            }
        }

        async function deleteComment(commentId) {
            if (!confirm('Kommentar wirklich l√∂schen?')) return;
            try {
                await remove(ref(database, `comments/${commentId}`));
                await loadComments();
                render();
            } catch (err) {
                console.error(err);
            }
        }

        function render() {
            const app = document.getElementById('app');
            
            if (!currentUser) {
                app.innerHTML = renderLogin();
                attachLoginListeners();
            } else if (newUserCode) {
                app.innerHTML = renderLogin();
                document.getElementById('continueToApp')?.addEventListener('click', () => {
                    localStorage.setItem('currentUserId', currentUser.userId);
                    newUserCode = null;
                    currentPage = 'checkliste';
                    render();
                });
            } else {
                app.innerHTML = renderNav() + renderContent() + (showRatingModal ? renderRatingModal() : '');
                attachNavListeners();
                attachContentListeners();
                if (showRatingModal) attachModalListeners();
            }
        }

        function renderLogin() {
            if (newUserCode) {
                return `
                    <div class="container">
                        <div class="card" style="max-width: 600px; margin: 50px auto;">
                            <h1>üéâ Account erstellt!</h1>
                            <p style="margin-bottom: 20px; color: #666;">
                                Dein pers√∂nlicher Code zum Anmelden:
                            </p>
                            <div class="code-display">
                                <div style="font-size: 14px; color: #666; margin-bottom: 10px;">Notiere dir diesen Code:</div>
                                <div class="code">${newUserCode}</div>
                                <div style="font-size: 14px; color: #666; margin-top: 10px;">
                                    Du ben√∂tigst ihn zum Anmelden auf anderen Ger√§ten
                                </div>
                            </div>
                            <button class="btn btn-primary" style="width: 100%;" id="continueToApp">
                                Weiter zur Checkliste
                            </button>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="container">
                    <div class="card" style="max-width: 600px; margin: 50px auto;">
                        <h1>üéì Willkommen zur to-teach.ai Weiterbildung</h1>
                        <p style="margin-bottom: 30px; color: #666;">
                            Bist du neu hier oder hast du bereits einen Code?
                        </p>
                        <div class="login-tabs">
                            <div class="login-tab ${loginMode === 'new' ? 'active' : ''}" data-mode="new">
                                ‚ú® Neu registrieren
                            </div>
                            <div class="login-tab ${loginMode === 'existing' ? 'active' : ''}" data-mode="existing">
                                üîë Mit Code anmelden
                            </div>
                        </div>
                        <div id="loginContent"></div>
                    </div>
                </div>
            `;
        }

        function renderNewUserForm() {
            return `
                <form id="newUserForm">
                    <div class="form-group">
                        <label>Dein Name (nur einmal verwendbar)</label>
                        <input type="text" id="username" placeholder="Max Mustermann" maxlength="30" required>
                    </div>
                    <div class="form-group">
                        <label>W√§hle deine Gruppe</label>
                        <div class="group-grid">
                            ${Object.entries(GROUPS).map(([id, g]) => `
                                <div class="group-option ${id}" data-group="${id}">
                                    <div style="font-size: 32px; margin-bottom: 5px;">${g.emoji}</div>
                                    <div>${g.name}</div>
                                </div>
                            `).join('')}
                        </div>
                        <input type="hidden" id="selectedGroup" required>
                    </div>
                    <div id="loginError" class="error-message"></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                        Account erstellen
                    </button>
                </form>
            `;
        }

        function renderExistingUserForm() {
            return `
                <form id="existingUserForm">
                    <div class="form-group">
                        <label>Dein pers√∂nlicher Code</label>
                        <input type="text" id="userCode" placeholder="ABC123" maxlength="6" required 
                               style="text-transform: uppercase; text-align: center; font-size: 24px; letter-spacing: 3px; font-family: monospace;">
                    </div>
                    <div id="loginError" class="error-message"></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                        Anmelden
                    </button>
                </form>
            `;
        }

        function attachLoginListeners() {
            document.querySelectorAll('.login-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    loginMode = tab.dataset.mode;
                    const content = document.getElementById('loginContent');
                    if (loginMode === 'new') {
                        content.innerHTML = renderNewUserForm();
                        attachNewUserListeners();
                    } else {
                        content.innerHTML = renderExistingUserForm();
                        attachExistingUserListeners();
                    }
                    document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                });
            });

            const content = document.getElementById('loginContent');
            if (loginMode === 'new') {
                content.innerHTML = renderNewUserForm();
                attachNewUserListeners();
            } else {
                content.innerHTML = renderExistingUserForm();
                attachExistingUserListeners();
            }
        }

        function attachNewUserListeners() {
            let selectedGroup = null;
            document.querySelectorAll('.group-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    document.querySelectorAll('.group-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    selectedGroup = opt.dataset.group;
                    document.getElementById('selectedGroup').value = selectedGroup;
                });
            });
            
            document.getElementById('newUserForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const group = document.getElementById('selectedGroup').value;
                const errorDiv = document.getElementById('loginError');
                const error = await handleNewUser(username, group);
                if (error) errorDiv.textContent = error;
            });
        }

        function attachExistingUserListeners() {
            const codeInput = document.getElementById('userCode');
            codeInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
            });

            document.getElementById('existingUserForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const code = document.getElementById('userCode').value;
                const errorDiv = document.getElementById('loginError');
                const error = await handleExistingUser(code);
                if (error) errorDiv.textContent = error;
            });
        }

        function renderNav() {
            return `
                <div class="container">
                    <nav class="nav">
                        <div class="nav-links">
                            <div class="nav-link ${currentPage === 'checkliste' ? 'active' : ''}" data-page="checkliste">üìã Checkliste</div>
                            <div class="nav-link ${currentPage === 'statistik' ? 'active' : ''}" data-page="statistik">üìä Statistik</div>
                            <div class="nav-link ${currentPage === 'pinnwand' ? 'active' : ''}" data-page="pinnwand">üìå Pinnwand</div>
                        </div>
                        <div class="user-info">
                            <span style="font-weight: 600;">${currentUser.username}</span>
                            <span class="group-badge ${currentUser.group}">${GROUPS[currentUser.group]?.emoji} ${GROUPS[currentUser.group]?.name}</span>
                            <span style="font-size: 12px; color: #999;">Code: ${currentUser.code}</span>
                            <button class="logout-btn" id="logoutBtn">Abmelden</button>
                        </div>
                    </nav>
                </div>
            `;
        }

        function attachNavListeners() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', async () => {
                    currentPage = link.dataset.page;
                    if (currentPage === 'statistik') await loadAllUsers();
                    if (currentPage === 'pinnwand') await loadComments();
                    render();
                });
            });
            document.getElementById('logoutBtn')?.addEventListener('click', handleLogout);
        }

        function renderContent() {
            if (currentPage === 'checkliste') return renderCheckliste();
            if (currentPage === 'statistik') return renderStatistik();
            if (currentPage === 'pinnwand') return renderPinnwand();
            return '';
        }

        function renderCheckliste() {
            let totalSubtasks = 0;
            let completedCount = 0;
            TASKS.forEach(task => {
                totalSubtasks += task.subtasks.length;
                task.subtasks.forEach((_, i) => {
                    if (completedSubtasks[getSubtaskKey(task.id, i)]) completedCount++;
                });
            });
            const percentage = Math.round((completedCount / totalSubtasks) * 100);
            
            return `
                <div class="container">
                    <div class="card">
                        <h1>üìã Checkliste</h1>
                        <div class="progress-bar-container">
                            <div class="progress-info">
                                <span>Dein Fortschritt: ${completedCount} / ${totalSubtasks} Unteraufgaben</span>
                                <span style="color: #667eea; font-size: 18px;">${percentage}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                        <div style="margin-top: 30px;">
                            ${TASKS.map((task, idx) => {
                                const taskCompleted = isTaskFullyCompleted(task.id);
                                const taskSubtasksCompleted = task.subtasks.filter((_, i) => 
                                    completedSubtasks[getSubtaskKey(task.id, i)]
                                ).length;
                                
                                return `
                                    <div class="task-item ${taskCompleted ? 'completed' : ''}">
                                        <div class="task-main-header">
                                            <div class="task-icon ${task.lionColor}">${task.lionEmoji}</div>
                                            <div class="task-main-content">
                                                <div class="task-title">
                                                    ${idx + 1}. ${task.title}
                                                    <span class="task-badge ${task.type}">
                                                        ${task.type === 'group' ? 'üë• Gruppenarbeit' : 'ü¶Å Einzelarbeit'}
                                                    </span>
                                                </div>
                                                <div class="task-progress">${taskSubtasksCompleted} / ${task.subtasks.length} abgehakt</div>
                                            </div>
                                        </div>
                                        <div class="subtasks">
                                            ${task.subtasks.map((subtask, subIdx) => {
                                                const subKey = getSubtaskKey(task.id, subIdx);
                                                const isCompleted = !!completedSubtasks[subKey];
                                                return `
                                                    <div class="subtask-item ${isCompleted ? 'completed' : ''}">
                                                        <input type="checkbox" class="subtask-checkbox" data-task="${task.id}" data-subtask="${subIdx}" ${isCompleted ? 'checked' : ''}>
                                                        <span class="subtask-text">${subtask}</span>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                        ${(task.pdfUrl || task.whiteboardUrl || task.padletUrl) ? `
                                            <div class="external-links">
                                                ${task.pdfUrl ? `
                                                    <a href="${task.pdfUrl}" target="_blank" class="external-link-btn pdf">
                                                        üìÑ Anleitung √∂ffnen
                                                    </a>
                                                ` : ''}
                                                ${task.whiteboardUrl ? `
                                                    <a href="${task.whiteboardUrl}" target="_blank" class="external-link-btn whiteboard">
                                                        üñºÔ∏è Whiteboard √∂ffnen
                                                    </a>
                                                ` : ''}
                                                ${task.padletUrl ? `
                                                    <a href="${task.padletUrl}" target="_blank" class="external-link-btn padlet">
                                                        üìå Padlet √∂ffnen
                                                    </a>
                                                ` : ''}
                                            </div>
                                        ` : ''}
                                        ${ratings[task.id] ? `
                                            <div class="task-rating-display">
                                                <strong>‚úÖ Aufgabe bewertet:</strong>
                                                ${RATING_QUESTIONS.map(q => {
                                                    const rating = ratings[task.id][q.id];
                                                    if (rating === null || rating === undefined) return '';
                                                    const option = RATING_OPTIONS.find(opt => opt.value === rating);
                                                    return option ? `${q.emoji} ${option.emoji} ${option.label}` : '';
                                                }).filter(x => x).join(' ¬∑ ')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStatistik() {
            const filteredUsers = selectedGroupFilter 
                ? allUsers.filter(u => u.group === selectedGroupFilter)
                : allUsers;

            const groupStats = {};
            Object.keys(GROUPS).forEach(g => {
                const groupUsers = allUsers.filter(u => u.group === g);
                let totalSubtasksCompleted = 0;
                let totalSubtasks = 0;
                TASKS.forEach(task => {
                    totalSubtasks += task.subtasks.length * groupUsers.length;
                    groupUsers.forEach(user => {
                        task.subtasks.forEach((_, i) => {
                            if (user.completedSubtasks && user.completedSubtasks[getSubtaskKey(task.id, i)]) {
                                totalSubtasksCompleted++;
                            }
                        });
                    });
                });
                const avgProgress = totalSubtasks > 0 ? Math.round((totalSubtasksCompleted / totalSubtasks) * 100) : 0;
                groupStats[g] = { count: groupUsers.length, progress: avgProgress };
            });

            let allSubtasksCount = 0;
            TASKS.forEach(t => allSubtasksCount += t.subtasks.length);

            const filterLabel = selectedGroupFilter 
                ? `${GROUPS[selectedGroupFilter].emoji} ${GROUPS[selectedGroupFilter].name}`
                : 'Alle Gruppen';
            
            return `
                <div class="container">
                    <div class="card">
                        <h1>üìä Statistik-√úbersicht</h1>
                        
                        <div class="group-filter">
                            <span class="group-filter-label">Filter:</span>
                            <div class="group-filter-badge all ${!selectedGroupFilter ? 'active' : ''}" data-group="all">
                                üåç Alle Gruppen
                            </div>
                            ${Object.entries(GROUPS).map(([id, g]) => `
                                <div class="group-filter-badge ${selectedGroupFilter === id ? 'active' : ''}" 
                                     style="background: ${g.color};" 
                                     data-group="${id}">
                                    ${g.emoji} ${g.name}
                                </div>
                            `).join('')}
                        </div>

                        <div class="stats-grid">
                            ${Object.entries(GROUPS).map(([id, g]) => `
                                <div class="stat-card" style="border-color: ${g.color};">
                                    <div class="stat-emoji">${g.emoji}</div>
                                    <div style="font-weight: 600; margin-bottom: 10px;">${g.name}</div>
                                    <div class="stat-value">${groupStats[id].count}</div>
                                    <div class="stat-label">Teilnehmer</div>
                                    <div class="stat-value" style="font-size: 20px; margin-top: 10px;">${groupStats[id].progress}%</div>
                                    <div class="stat-label">√ò Fortschritt</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="card">
                        <h2>üìà Detaillierte Aufgabenstatistik - ${filterLabel}</h2>
                        <div class="anonymous-note">
                            <strong>üîí Hinweis:</strong> Alle Bewertungen werden anonymisiert angezeigt, um die Privatsph√§re der Teilnehmer zu sch√ºtzen.
                        </div>
                        <div class="task-stats">
                            ${TASKS.map((task, idx) => {
                                let taskStats = { total: filteredUsers.length, completed: 0 };
                                let subtaskStats = task.subtasks.map(() => ({ total: filteredUsers.length, completed: 0 }));
                                
                                let ratingStats = {
                                    enjoyed: { values: [0, 0, 0, 0], total: 0 },
                                    useful: { values: [0, 0, 0, 0], total: 0 },
                                    learned: { values: [0, 0, 0, 0], total: 0 }
                                };

                                filteredUsers.forEach(user => {
                                    let userTaskCompleted = true;
                                    task.subtasks.forEach((_, subIdx) => {
                                        const key = getSubtaskKey(task.id, subIdx);
                                        if (user.completedSubtasks && user.completedSubtasks[key]) {
                                            subtaskStats[subIdx].completed++;
                                        } else {
                                            userTaskCompleted = false;
                                        }
                                    });
                                    if (userTaskCompleted) taskStats.completed++;

                                    if (user.ratings && user.ratings[task.id]) {
                                        const rating = user.ratings[task.id];
                                        RATING_QUESTIONS.forEach(q => {
                                            const val = rating[q.id];
                                            if (val !== null && val !== undefined) {
                                                ratingStats[q.id].total++;
                                                ratingStats[q.id].values[val]++;
                                            }
                                        });
                                    }
                                });

                                const taskPercentage = taskStats.total > 0 ? Math.round((taskStats.completed / taskStats.total) * 100) : 0;

                                return `
                                    <div class="task-stat-item">
                                        <div class="task-stat-header">
                                            <strong>${idx + 1}. ${task.title}</strong>
                                            <span style="color: #667eea; font-weight: 600;">${taskStats.completed}/${taskStats.total} (${taskPercentage}%)</span>
                                        </div>
                                        <div class="stat-bar">
                                            <div class="stat-bar-fill" style="width: ${taskPercentage}%; background: ${GROUPS[Object.keys(GROUPS)[idx % 5]].color};"></div>
                                        </div>
                                        <div class="subtask-stats">
                                            ${task.subtasks.map((subtask, subIdx) => {
                                                const subPercentage = subtaskStats[subIdx].total > 0 
                                                    ? Math.round((subtaskStats[subIdx].completed / subtaskStats[subIdx].total) * 100) 
                                                    : 0;
                                                return `
                                                    <div class="subtask-stat">
                                                        <span style="font-size: 14px;">${subtask}</span>
                                                        <span style="font-weight: 600; color: #666;">${subtaskStats[subIdx].completed}/${subtaskStats[subIdx].total} (${subPercentage}%)</span>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>

                                        ${ratingStats.enjoyed.total > 0 || ratingStats.useful.total > 0 || ratingStats.learned.total > 0 ? `
                                            <div class="rating-stats">
                                                <div class="rating-stats-header">
                                                    <span>üìä Anonymisierte Bewertungen</span>
                                                    <span style="font-size: 14px; color: #999;">${Math.max(ratingStats.enjoyed.total, ratingStats.useful.total, ratingStats.learned.total)} Bewertungen</span>
                                                </div>
                                                ${RATING_QUESTIONS.map(q => {
                                                    const stats = ratingStats[q.id];
                                                    if (stats.total === 0) return '';
                                                    
                                                    return `
                                                        <div class="rating-question-stats">
                                                            <div class="rating-question-label">
                                                                ${q.emoji} ${q.label}
                                                            </div>
                                                            <div class="rating-bar-group">
                                                                ${RATING_OPTIONS.map((opt, optIdx) => {
                                                                    const count = stats.values[opt.value];
                                                                    const percent = stats.total > 0 ? Math.round((count / stats.total) * 100) : 0;
                                                                    return `
                                                                        <div class="rating-bar-item" style="flex: ${count || 1};">
                                                                            <div class="rating-bar-visual" style="background: ${opt.color}; opacity: ${count > 0 ? 1 : 0.3};">
                                                                                ${count > 0 ? `${count} (${percent}%)` : '0'}
                                                                            </div>
                                                                            <div class="rating-bar-label">${opt.emoji} ${opt.label}</div>
                                                                        </div>
                                                                    `;
                                                                }).join('')}
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div class="card">
                        <h2>üë• Teilnehmer - ${filterLabel} (${filteredUsers.length})</h2>
                        <div class="user-list">
                            ${filteredUsers.length === 0 ? '<p style="color: #999;">Keine Teilnehmer in dieser Gruppe</p>' : filteredUsers.map(user => {
                                let userCompleted = 0;
                                TASKS.forEach(task => {
                                    task.subtasks.forEach((_, i) => {
                                        if (user.completedSubtasks && user.completedSubtasks[getSubtaskKey(task.id, i)]) {
                                            userCompleted++;
                                        }
                                    });
                                });
                                const progress = Math.round((userCompleted / allSubtasksCount) * 100);
                                return `
                                    <div class="user-row">
                                        <div class="user-name">
                                            ${user.username}
                                            <span class="mini-badge" style="background: ${GROUPS[user.group]?.color};">${GROUPS[user.group]?.emoji}</span>
                                        </div>
                                        <div class="progress-mini">
                                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">${userCompleted} / ${allSubtasksCount} (${progress}%)</div>
                                            <div class="progress-mini-bar">
                                                <div class="progress-mini-fill" style="width: ${progress}%; background: ${GROUPS[user.group]?.color};"></div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPinnwand() {
            return `
                <div class="container">
                    <div class="card">
                        <h1>üìå Pinnwand</h1>
                        <p style="color: #666; margin-bottom: 20px;">Teile deine Gedanken und Feedback zur Weiterbildung!</p>
                        <div class="comment-form">
                            <textarea id="newComment" class="comment-textarea" placeholder="Schreibe einen Kommentar..." maxlength="500"></textarea>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                                <span style="font-size: 14px; color: #999;" id="charCount">0 / 500</span>
                                <button class="btn btn-primary" id="postCommentBtn">Kommentar posten</button>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h2>üí¨ Alle Kommentare (${comments.length})</h2>
                        <div class="comments-list">
                            ${comments.length === 0 ? '<p style="color: #999;">Noch keine Kommentare</p>' : comments.map(comment => `
                                <div class="comment-item" style="border-color: ${GROUPS[comment.group]?.color};">
                                    <div class="comment-header">
                                        <div class="comment-author">
                                            ${comment.username}
                                            <span class="mini-badge" style="background: ${GROUPS[comment.group]?.color};">${GROUPS[comment.group]?.emoji}</span>
                                        </div>
                                        <div>
                                            <span class="comment-date">${new Date(comment.timestamp).toLocaleString('de-DE')}</span>
                                            ${comment.userId === currentUser.userId ? `
                                                <button class="delete-comment-btn" data-comment="${comment.id}">L√∂schen</button>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="comment-text">${comment.text}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRatingModal() {
            const task = TASKS.find(t => t.id === showRatingModal);
            const canSubmit = Object.values(tempRating).some(v => v !== null && v !== undefined);
            
            return `
                <div class="modal-overlay" id="modalOverlay">
                    <div class="modal-content">
                        <h2>üéâ Aufgabe geschafft!</h2>
                        <p style="margin-bottom: 15px; color: #666;">${task.title}</p>
                        <div class="anonymous-note" style="margin-bottom: 25px;">
                            <strong>üîí Hinweis:</strong> Deine Bewertungen werden anonymisiert mit anderen Teilnehmern geteilt und in der Statistik sichtbar gemacht.
                        </div>
                        ${RATING_QUESTIONS.map(q => `
                            <div class="rating-question">
                                <label>${q.emoji} ${q.label}</label>
                                <div class="rating-options">
                                    ${RATING_OPTIONS.map(opt => `
                                        <button class="rating-btn ${tempRating[q.id] === opt.value ? 'selected' : ''}" 
                                                data-question="${q.id}" 
                                                data-value="${opt.value}"
                                                style="${tempRating[q.id] === opt.value ? `background: ${opt.color};` : ''}">
                                            <span class="rating-btn-emoji">${opt.emoji}</span>
                                            <span class="rating-btn-label">${opt.label}</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                        <div class="modal-actions">
                            <button class="btn btn-secondary" id="skipBtn" style="flex: 1;">√úberspringen</button>
                            <button class="btn btn-primary" id="submitBtn" style="flex: 1;" ${!canSubmit ? 'disabled' : ''}>Speichern</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function attachContentListeners() {
            document.querySelectorAll('.group-filter-badge').forEach(badge => {
                badge.addEventListener('click', () => {
                    const group = badge.dataset.group;
                    selectedGroupFilter = group === 'all' ? null : group;
                    render();
                });
            });

            document.querySelectorAll('.subtask-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const taskId = parseInt(e.target.dataset.task);
                    const subtaskIdx = parseInt(e.target.dataset.subtask);
                    toggleSubtask(taskId, subtaskIdx);
                });
            });

            const commentTextarea = document.getElementById('newComment');
            const charCount = document.getElementById('charCount');
            if (commentTextarea && charCount) {
                commentTextarea.addEventListener('input', () => {
                    charCount.textContent = `${commentTextarea.value.length} / 500`;
                });
            }

            document.getElementById('postCommentBtn')?.addEventListener('click', () => {
                const text = document.getElementById('newComment').value;
                if (text.trim()) {
                    postComment(text);
                    document.getElementById('newComment').value = '';
                }
            });

            document.querySelectorAll('.delete-comment-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    deleteComment(btn.dataset.comment);
                });
            });
        }

        function attachModalListeners() {
            document.querySelectorAll('.rating-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    setRating(btn.dataset.question, btn.dataset.value);
                });
            });
            document.getElementById('skipBtn')?.addEventListener('click', skipRating);
            document.getElementById('submitBtn')?.addEventListener('click', submitRating);
            document.getElementById('modalOverlay')?.addEventListener('click', (e) => {
                if (e.target.id === 'modalOverlay') skipRating();
            });
        }

        init();
    </script>
</body>
</html>
