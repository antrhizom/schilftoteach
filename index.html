<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weiterbildung to-teach.ai - Checkliste</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .nav { background: rgba(255, 255, 255, 0.95); padding: 15px 30px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; border-radius: 10px; flex-wrap: wrap; gap: 15px; }
        .nav-links { display: flex; gap: 15px; flex-wrap: wrap; }
        .nav-link { padding: 8px 16px; border-radius: 5px; background: #e0e0e0; color: #667eea; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .nav-link:hover, .nav-link.active { background: #667eea; color: white; }
        .user-info { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .group-badge { padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: 600; color: white; }
        .logout-btn { background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: 600; }
        .card { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); margin-bottom: 20px; }
        .card h1, .card h2 { color: #667eea; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        .group-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
        .group-option { padding: 20px; border: 3px solid transparent; border-radius: 10px; cursor: pointer; text-align: center; font-weight: 600; font-size: 18px; color: white; transition: all 0.3s; }
        .group-option:hover { transform: scale(1.05); }
        .group-option.selected { border-color: #fff; box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.5); }
        .group-option.nilpferde, .group-badge.nilpferde { background: #3498db; }
        .group-option.ameise, .group-badge.ameise { background: #e74c3c; }
        .group-option.schildkroeten, .group-badge.schildkroeten { background: #2ecc71; }
        .group-option.drachen, .group-badge.drachen { background: #f39c12; }
        .group-option.kuehe, .group-badge.kuehe { background: #9b59b6; }
        .btn { padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover:not(:disabled) { background: #5568d3; transform: translateY(-2px); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .error-message { color: #e74c3c; margin-top: 10px; }
        .progress-bar-container { margin: 30px 0; }
        .progress-info { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: 600; }
        .progress-bar { height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.5s ease; }
        .task-item { background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 20px; transition: all 0.3s; }
        .task-item:hover { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .task-item.completed { background: #e8f5e9; border-color: #4caf50; }
        .task-main-header { display: flex; gap: 15px; align-items: flex-start; margin-bottom: 15px; }
        .task-icon { width: 60px; height: 60px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 36px; flex-shrink: 0; background: #f0f0f0; border: 3px solid; }
        .task-icon.lion-red { border-color: #e74c3c; background: #ffebee; }
        .task-icon.lion-blue { border-color: #3498db; background: #e3f2fd; }
        .task-icon.lion-green { border-color: #2ecc71; background: #e8f5e9; }
        .task-icon.lion-orange { border-color: #f39c12; background: #fff3e0; }
        .task-icon.lion-purple { border-color: #9b59b6; background: #f3e5f5; }
        .task-icon.lion-yellow { border-color: #f1c40f; background: #fffde7; }
        .task-icon.lion-teal { border-color: #1abc9c; background: #e0f2f1; }
        .task-icon.lion-pink { border-color: #e91e63; background: #fce4ec; }
        .task-main-content { flex: 1; }
        .task-title { font-weight: 700; margin-bottom: 5px; font-size: 18px; color: #333; }
        .task-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; margin-left: 10px; }
        .task-badge.individual { background: #fff3e0; color: #f57c00; }
        .task-badge.group { background: #e3f2fd; color: #1976d2; }
        .task-progress { font-size: 14px; color: #666; margin-top: 5px; }
        .subtasks { margin-top: 15px; padding-left: 0; }
        .subtask-item { display: flex; align-items: flex-start; gap: 12px; padding: 10px; margin-bottom: 8px; background: white; border-radius: 8px; transition: all 0.3s; }
        .subtask-item:hover { background: #f0f7ff; }
        .subtask-item.completed { background: #e8f5e9; }
        .subtask-checkbox { width: 20px; height: 20px; cursor: pointer; flex-shrink: 0; margin-top: 2px; }
        .subtask-text { flex: 1; color: #555; line-height: 1.5; }
        .task-rating-display { margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0; font-size: 14px; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-content { background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-content h2 { color: #667eea; margin-bottom: 10px; }
        .rating-question { margin: 25px 0; }
        .rating-question label { display: block; font-weight: 600; color: #333; margin-bottom: 12px; font-size: 16px; }
        .rating-options { display: flex; gap: 15px; }
        .rating-btn { flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 10px; background: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .rating-btn:hover { border-color: #667eea; }
        .rating-btn.selected.positive { background: #4caf50; color: white; border-color: #4caf50; }
        .rating-btn.selected.negative { background: #f44336; color: white; border-color: #f44336; }
        .modal-actions { display: flex; gap: 15px; margin-top: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: #f8f9fa; border-left: 5px solid; border-radius: 10px; padding: 20px; text-align: center; }
        .stat-emoji { font-size: 36px; margin-bottom: 10px; }
        .stat-value { font-size: 28px; font-weight: 700; color: #667eea; }
        .stat-label { color: #666; font-size: 14px; margin-top: 5px; }
        .user-list { margin-top: 30px; }
        .user-row { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .user-name { font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .mini-badge { padding: 3px 10px; border-radius: 12px; font-size: 12px; color: white; }
        .progress-mini { flex: 1; min-width: 200px; }
        .progress-mini-bar { height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .progress-mini-fill { height: 100%; transition: width 0.5s; }
        .loading { text-align: center; padding: 50px; color: white; font-size: 20px; }
        @media (max-width: 768px) {
            .nav { flex-direction: column; }
            .group-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
            .task-icon { width: 50px; height: 50px; font-size: 28px; }
            .rating-options, .modal-actions { flex-direction: column; }
            .modal-actions button { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="app"><div class="loading">L√§dt...</div></div>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyC5WFZHxE19M5lN08cHBD_1P5x2zDuLNHI",
            authDomain: "weiterbildung-to-teach.firebaseapp.com",
            databaseURL: "https://weiterbildung-to-teach-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "weiterbildung-to-teach",
            storageBucket: "weiterbildung-to-teach.firebasestorage.app",
            messagingSenderId: "316765773128",
            appId: "1:316765773128:web:7ae13ea61f3e9c2e52677d"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const GROUPS = {
            nilpferde: { name: 'Nilpferde', emoji: 'ü¶õ', color: '#3498db' },
            ameise: { name: 'Ameise', emoji: 'üêú', color: '#e74c3c' },
            schildkroeten: { name: 'Schildkr√∂ten', emoji: 'üê¢', color: '#2ecc71' },
            drachen: { name: 'Drachen', emoji: 'üêâ', color: '#f39c12' },
            kuehe: { name: 'K√ºhe', emoji: 'üêÑ', color: '#9b59b6' }
        };

        const TASKS = [
            { 
                id: 1, 
                title: 'Ein KI-Chatbot steht zur Verf√ºgung', 
                type: 'individual',
                lionColor: 'lion-red',
                lionEmoji: 'ü¶Å',
                subtasks: [
                    'Ich habe Zugriff auf den KI-Chat von Microsoft',
                    'Ich weiss, dass ich den Input genau definieren muss, damit der Output qualitativ hochwertig ist'
                ]
            },
            { 
                id: 2, 
                title: 'Registrierung Schullizenz', 
                type: 'individual',
                lionColor: 'lion-blue',
                lionEmoji: 'ü¶Å',
                subtasks: [
                    'Ich bin bei Fobizz registriert',
                    'Ich habe den Pro-Plan in to-teach.ai'
                ]
            },
            { 
                id: 3, 
                title: 'Erste Schritte in to-teach.ai', 
                type: 'individual',
                lionColor: 'lion-green',
                lionEmoji: 'ü¶Å',
                subtasks: [
                    'Ich habe ein Youtube-Aufgabenblatt erstellt',
                    'Ich habe eine Powerpoint erstellt',
                    'Ich habe eine Infografik erstellt'
                ]
            },
            { 
                id: 4, 
                title: 'Gruppenarbeit A', 
                type: 'group',
                lionColor: 'lion-orange',
                lionEmoji: 'üë•',
                subtasks: [
                    'Zwischenstandkontrolle in der Gruppe',
                    'Einzellinks sind auf dem Whiteboard festgehalten'
                ]
            },
            { 
                id: 5, 
                title: 'Aufgabenbausteine in to-teach.ai kennenlernen', 
                type: 'individual',
                lionColor: 'lion-purple',
                lionEmoji: 'ü¶Å',
                subtasks: [
                    'Ich habe den Baustein ‚ÄûAussagen" erstellt',
                    'Ich habe den Baustein ‚ÄûMindmap" erstellt',
                    'Ich habe den Baustein ‚ÄûWhatsapp Chat" erstellt'
                ]
            },
            { 
                id: 6, 
                title: 'Organisation von to-teach.ai-Inhalten', 
                type: 'individual',
                lionColor: 'lion-yellow',
                lionEmoji: 'ü¶Å',
                subtasks: [
                    'Ich habe zwei Ordner erstellt',
                    'Ich habe einen Kurs erstellt'
                ]
            },
            { 
                id: 7, 
                title: 'Gruppenarbeit B', 
                type: 'group',
                lionColor: 'lion-teal',
                lionEmoji: 'üë•',
                subtasks: [
                    'Zwischenstandkontrolle in der Gruppe',
                    'Einzellinks sind auf dem Whiteboard festgehalten'
                ]
            },
            { 
                id: 8, 
                title: 'Gruppenarbeit C', 
                type: 'group',
                lionColor: 'lion-pink',
                lionEmoji: 'üë•',
                subtasks: [
                    'Entscheid in der Gruppe, welche Links von erstellten Inhalten auf das Padlet kommen',
                    'Mindestens f√ºnf Links mit Begr√ºndung'
                ]
            }
        ];

        const RATING_QUESTIONS = [
            { id: 'enjoyed', label: 'Hat es mir Spa√ü gemacht?', emoji: 'üòä' },
            { id: 'useful', label: 'War es sinnvoll?', emoji: 'üí°' },
            { id: 'learned', label: 'Habe ich etwas gelernt?', emoji: 'üìö' }
        ];

        let currentUser = null;
        let currentPage = 'login';
        let completedSubtasks = {};
        let ratings = {};
        let allUsers = [];
        let showRatingModal = null;
        let tempRating = {};

        async function init() {
            const savedUserId = localStorage.getItem('currentUserId');
            if (savedUserId) {
                try {
                    const userRef = ref(database, `users/${savedUserId}`);
                    const snapshot = await get(userRef);
                    if (snapshot.exists()) {
                        currentUser = { ...snapshot.val(), userId: savedUserId };
                        currentPage = 'checkliste';
                        await loadUserData();
                    } else {
                        localStorage.removeItem('currentUserId');
                    }
                } catch (err) {
                    console.error(err);
                }
            }
            render();
        }

        async function loadUserData() {
            if (!currentUser) return;
            try {
                const userRef = ref(database, `users/${currentUser.userId}`);
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    completedSubtasks = data.completedSubtasks || {};
                    ratings = data.ratings || {};
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function loadAllUsers() {
            try {
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);
                if (snapshot.exists()) {
                    const usersData = snapshot.val();
                    allUsers = Object.entries(usersData).map(([id, data]) => ({
                        userId: id,
                        ...data
                    }));
                } else {
                    allUsers = [];
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function handleLogin(username, group) {
            if (!username || !group) {
                return 'Bitte Namen und Gruppe ausw√§hlen';
            }

            try {
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    const existingUser = Object.entries(users).find(
                        ([id, u]) => u.username.toLowerCase() === username.toLowerCase()
                    );
                    
                    if (existingUser) {
                        const [userId, userData] = existingUser;
                        currentUser = { ...userData, userId };
                        localStorage.setItem('currentUserId', userId);
                        currentPage = 'checkliste';
                        await loadUserData();
                        render();
                        return null;
                    }
                }

                const userId = Date.now().toString();
                const newUser = {
                    username: username.trim(),
                    group: group,
                    createdAt: new Date().toISOString(),
                    completedSubtasks: {},
                    ratings: {}
                };

                await set(ref(database, `users/${userId}`), newUser);
                
                currentUser = { ...newUser, userId };
                localStorage.setItem('currentUserId', userId);
                currentPage = 'checkliste';
                completedSubtasks = {};
                ratings = {};
                render();
                return null;
            } catch (err) {
                console.error(err);
                return 'Fehler beim Anmelden';
            }
        }

        function handleLogout() {
            if (confirm('Wirklich abmelden?')) {
                currentUser = null;
                localStorage.removeItem('currentUserId');
                currentPage = 'login';
                completedSubtasks = {};
                ratings = {};
                render();
            }
        }

        function getSubtaskKey(taskId, subtaskIndex) {
            return `${taskId}-${subtaskIndex}`;
        }

        function isTaskFullyCompleted(taskId) {
            const task = TASKS.find(t => t.id === taskId);
            if (!task) return false;
            
            for (let i = 0; i < task.subtasks.length; i++) {
                if (!completedSubtasks[getSubtaskKey(taskId, i)]) {
                    return false;
                }
            }
            return true;
        }

        async function toggleSubtask(taskId, subtaskIndex) {
            const key = getSubtaskKey(taskId, subtaskIndex);
            const newCompleted = { ...completedSubtasks };
            
            if (newCompleted[key]) {
                delete newCompleted[key];
            } else {
                newCompleted[key] = new Date().toISOString();
            }

            completedSubtasks = newCompleted;
            await set(ref(database, `users/${currentUser.userId}/completedSubtasks`), newCompleted);

            if (isTaskFullyCompleted(taskId) && !ratings[taskId]) {
                showRatingModal = taskId;
                tempRating = { enjoyed: null, useful: null, learned: null };
            }
            
            render();
        }

        async function submitRating() {
            const taskId = showRatingModal;
            const newRatings = { ...ratings };
            newRatings[taskId] = { ...tempRating, timestamp: new Date().toISOString() };
            ratings = newRatings;

            await set(ref(database, `users/${currentUser.userId}/ratings`), newRatings);
            
            showRatingModal = null;
            tempRating = {};
            render();
        }

        function skipRating() {
            showRatingModal = null;
            tempRating = {};
            render();
        }

        function setRating(questionId, value) {
            tempRating[questionId] = value;
            render();
        }

        function render() {
            const app = document.getElementById('app');
            
            if (!currentUser) {
                app.innerHTML = renderLogin();
                attachLoginListeners();
            } else {
                app.innerHTML = renderNav() + renderContent() + (showRatingModal ? renderRatingModal() : '');
                attachNavListeners();
                attachContentListeners();
                if (showRatingModal) attachModalListeners();
            }
        }

        function renderLogin() {
            return `
                <div class="container">
                    <div class="card" style="max-width: 600px; margin: 50px auto;">
                        <h1>üéì Willkommen zur to-teach.ai Weiterbildung</h1>
                        <p style="margin-bottom: 30px; color: #666;">
                            Bitte melde dich an, um mit der Checkliste zu beginnen.
                        </p>
                        <form id="loginForm">
                            <div class="form-group">
                                <label>Dein Name (du kannst dich auch von anderen Ger√§ten anmelden)</label>
                                <input type="text" id="username" placeholder="Max Mustermann" maxlength="30" required>
                            </div>
                            <div class="form-group">
                                <label>W√§hle deine Gruppe</label>
                                <div class="group-grid">
                                    ${Object.entries(GROUPS).map(([id, g]) => `
                                        <div class="group-option ${id}" data-group="${id}">
                                            <div style="font-size: 32px; margin-bottom: 5px;">${g.emoji}</div>
                                            <div>${g.name}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                <input type="hidden" id="selectedGroup" required>
                            </div>
                            <div id="loginError" class="error-message"></div>
                            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                                Anmelden
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function attachLoginListeners() {
            let selectedGroup = null;
            document.querySelectorAll('.group-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    document.querySelectorAll('.group-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    selectedGroup = opt.dataset.group;
                    document.getElementById('selectedGroup').value = selectedGroup;
                });
            });
            
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const group = document.getElementById('selectedGroup').value;
                const errorDiv = document.getElementById('loginError');
                const error = await handleLogin(username, group);
                if (error) errorDiv.textContent = error;
            });
        }

        function renderNav() {
            return `
                <div class="container">
                    <nav class="nav">
                        <div class="nav-links">
                            <div class="nav-link ${currentPage === 'checkliste' ? 'active' : ''}" data-page="checkliste">üìã Checkliste</div>
                            <div class="nav-link ${currentPage === 'statistik' ? 'active' : ''}" data-page="statistik">üìä Statistik</div>
                            <div class="nav-link ${currentPage === 'pinnwand' ? 'active' : ''}" data-page="pinnwand">üìå Pinnwand</div>
                        </div>
                        <div class="user-info">
                            <span style="font-weight: 600;">${currentUser.username}</span>
                            <span class="group-badge ${currentUser.group}">${GROUPS[currentUser.group]?.emoji} ${GROUPS[currentUser.group]?.name}</span>
                            <button class="logout-btn" id="logoutBtn">Abmelden</button>
                        </div>
                    </nav>
                </div>
            `;
        }

        function attachNavListeners() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', async () => {
                    currentPage = link.dataset.page;
                    if (currentPage === 'statistik') await loadAllUsers();
                    render();
                });
            });
            document.getElementById('logoutBtn')?.addEventListener('click', handleLogout);
        }

        function renderContent() {
            if (currentPage === 'checkliste') return renderCheckliste();
            if (currentPage === 'statistik') return renderStatistik();
            if (currentPage === 'pinnwand') return renderPinnwand();
            return '';
        }

        function renderCheckliste() {
            let totalSubtasks = 0;
            let completedCount = 0;
            TASKS.forEach(task => {
                totalSubtasks += task.subtasks.length;
                task.subtasks.forEach((_, i) => {
                    if (completedSubtasks[getSubtaskKey(task.id, i)]) completedCount++;
                });
            });
            const percentage = Math.round((completedCount / totalSubtasks) * 100);
            
            return `
                <div class="container">
                    <div class="card">
                        <h1>üìã Checkliste</h1>
                        <div class="progress-bar-container">
                            <div class="progress-info">
                                <span>Dein Fortschritt: ${completedCount} / ${totalSubtasks} Unteraufgaben</span>
                                <span style="color: #667eea; font-size: 18px;">${percentage}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                        <div style="margin-top: 30px;">
                            ${TASKS.map((task, idx) => {
                                const taskCompleted = isTaskFullyCompleted(task.id);
                                const taskSubtasksCompleted = task.subtasks.filter((_, i) => 
                                    completedSubtasks[getSubtaskKey(task.id, i)]
                                ).length;
                                
                                return `
                                    <div class="task-item ${taskCompleted ? 'completed' : ''}">
                                        <div class="task-main-header">
                                            <div class="task-icon ${task.lionColor}">
                                                ${task.lionEmoji}
                                            </div>
                                            <div class="task-main-content">
                                                <div class="task-title">
                                                    ${idx + 1}. ${task.title}
                                                    <span class="task-badge ${task.type}">
                                                        ${task.type === 'group' ? 'üë• Gruppenarbeit' : 'ü¶Å Einzelarbeit'}
                                                    </span>
                                                </div>
                                                <div class="task-progress">
                                                    ${taskSubtasksCompleted} / ${task.subtasks.length} abgehakt
                                                </div>
                                            </div>
                                        </div>
                                        <div class="subtasks">
                                            ${task.subtasks.map((subtask, subIdx) => {
                                                const subKey = getSubtaskKey(task.id, subIdx);
                                                const isCompleted = !!completedSubtasks[subKey];
                                                return `
                                                    <div class="subtask-item ${isCompleted ? 'completed' : ''}">
                                                        <input type="checkbox" 
                                                               class="subtask-checkbox" 
                                                               data-task="${task.id}" 
                                                               data-subtask="${subIdx}"
                                                               ${isCompleted ? 'checked' : ''}>
                                                        <span class="subtask-text">${subtask}</span>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                        ${ratings[task.id] ? `
                                            <div class="task-rating-display">
                                                <strong>‚úÖ Aufgabe bewertet:</strong>
                                                ${RATING_QUESTIONS.map(q => 
                                                    ratings[task.id][q.id] !== null 
                                                        ? `${q.emoji} ${ratings[task.id][q.id] ? 'üëç' : 'üëé'}` 
                                                        : ''
                                                ).filter(x => x).join(' ¬∑ ')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStatistik() {
            const groupStats = {};
            Object.keys(GROUPS).forEach(g => {
                const groupUsers = allUsers.filter(u => u.group === g);
                let totalSubtasksCompleted = 0;
                let totalSubtasks = 0;
                TASKS.forEach(task => {
                    totalSubtasks += task.subtasks.length * groupUsers.length;
                    groupUsers.forEach(user => {
                        task.subtasks.forEach((_, i) => {
                            if (user.completedSubtasks && user.completedSubtasks[getSubtaskKey(task.id, i)]) {
                                totalSubtasksCompleted++;
                            }
                        });
                    });
                });
                const avgProgress = totalSubtasks > 0 ? Math.round((totalSubtasksCompleted / totalSubtasks) * 100) : 0;
                groupStats[g] = { count: groupUsers.length, progress: avgProgress };
            });
            
            let allSubtasksCount = 0;
            TASKS.forEach(t => allSubtasksCount += t.subtasks.length);
            
            return `
                <div class="container">
                    <div class="card">
                        <h1>üìä Statistik-√úbersicht</h1>
                        <div class="stats-grid">
                            ${Object.entries(GROUPS).map(([id, g]) => `
                                <div class="stat-card" style="border-color: ${g.color};">
                                    <div class="stat-emoji">${g.emoji}</div>
                                    <div style="font-weight: 600; margin-bottom: 10px;">${g.name}</div>
                                    <div class="stat-value">${groupStats[id].count}</div>
                                    <div class="stat-label">Teilnehmer</div>
                                    <div class="stat-value" style="font-size: 20px; margin-top: 10px;">${groupStats[id].progress}%</div>
                                    <div class="stat-label">√ò Fortschritt</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="card">
                        <h2>üë• Alle Teilnehmer</h2>
                        <div class="user-list">
                            ${allUsers.length === 0 ? '<p style="color: #999;">Noch keine Teilnehmer</p>' : allUsers.map(user => {
                                let userCompleted = 0;
                                TASKS.forEach(task => {
                                    task.subtasks.forEach((_, i) => {
                                        if (user.completedSubtasks && user.completedSubtasks[getSubtaskKey(task.id, i)]) {
                                            userCompleted++;
                                        }
                                    });
                                });
                                const progress = Math.round((userCompleted / allSubtasksCount) * 100);
                                return `
                                    <div class="user-row">
                                        <div class="user-name">
                                            ${user.username}
                                            <span class="mini-badge" style="background: ${GROUPS[user.group]?.color};">${GROUPS[user.group]?.emoji}</span>
                                        </div>
                                        <div class="progress-mini">
                                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">
                                                ${userCompleted} / ${allSubtasksCount} (${progress}%)
                                            </div>
                                            <div class="progress-mini-bar">
                                                <div class="progress-mini-fill" style="width: ${progress}%; background: ${GROUPS[user.group]?.color};"></div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPinnwand() {
            return `
                <div class="container">
                    <div class="card">
                        <h1>üìå Pinnwand</h1>
                        <p style="color: #666;">Die Pinnwand-Funktion wird bald verf√ºgbar sein!</p>
                    </div>
                </div>
            `;
        }

        function renderRatingModal() {
            const task = TASKS.find(t => t.id === showRatingModal);
            const canSubmit = Object.values(tempRating).some(v => v !== null);
            
            return `
                <div class="modal-overlay" id="modalOverlay">
                    <div class="modal-content">
                        <h2>üéâ Aufgabe geschafft!</h2>
                        <p style="margin-bottom: 25px; color: #666;">${task.title}</p>
                        ${RATING_QUESTIONS.map(q => `
                            <div class="rating-question">
                                <label>${q.emoji} ${q.label}</label>
                                <div class="rating-options">
                                    <button class="rating-btn ${tempRating[q.id] === true ? 'selected positive' : ''}" 
                                            data-question="${q.id}" data-value="true">üëç Ja</button>
                                    <button class="rating-btn ${tempRating[q.id] === false ? 'selected negative' : ''}" 
                                            data-question="${q.id}" data-value="false">üëé Nein</button>
                                </div>
                            </div>
                        `).join('')}
                        <div class="modal-actions">
                            <button class="btn btn-secondary" id="skipBtn" style="flex: 1;">√úberspringen</button>
                            <button class="btn btn-primary" id="submitBtn" style="flex: 1;" ${!canSubmit ? 'disabled' : ''}>Speichern</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function attachContentListeners() {
            document.querySelectorAll('.subtask-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const taskId = parseInt(e.target.dataset.task);
                    const subtaskIdx = parseInt(e.target.dataset.subtask);
                    toggleSubtask(taskId, subtaskIdx);
                });
            });
        }

        function attachModalListeners() {
            document.querySelectorAll('.rating-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    setRating(btn.dataset.question, btn.dataset.value === 'true');
                });
            });
            document.getElementById('skipBtn')?.addEventListener('click', skipRating);
            document.getElementById('submitBtn')?.addEventListener('click', submitRating);
            document.getElementById('modalOverlay')?.addEventListener('click', (e) => {
                if (e.target.id === 'modalOverlay') skipRating();
            });
        }

        init();
    </script>
</body>
</html>
